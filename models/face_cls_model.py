"""
TODO: 使用dlib提取脸部特征点以及描述符特征;
      基于自定义深度学习模型训练提取
Time: 2025/03/09-Redal
"""
import os
import sys
import dlib
import cv2
import torch
import argparse
import numpy as np
from PIL import Image
import tensorflow as tf

project_path = os.getcwd()
current_path = os.path.join(os.path.dirname(__file__))
sys.path.append(current_path)
sys.path.append(project_path)
device = torch.device('cuda:0' if torch.cuda.is_available() else 'cpu')
os.environ['CUDA_VISIBLE_DEVICES'] = '0'



##########################  变量阈定义处理  ##########################
def face_config():
      parser = argparse.ArgumentParser(description='Face Recognition models and methods',
                                     formatter_class=argparse.ArgumentDefaultsHelpFormatter)
      parser.add_argument_group('Dlib Extractor')
      parser.add_argument('--dlib_dirs', type=str, default=os.path.join(project_path, 'weights'),
                        help='the directory of dlib weights')
      parser.add_argument('--dlib_predictor', type=str, default='face_predictor_68_face_landmarks.dat',
                        help='the name of dlib dlib predictor')
      parser.add_argument('--dlib_resnet', type=str, default='face_recognition_resnet_model_v1.dat',
                        help='the name of dlib resnet model for face recognition')
      
      parser.add_argument_group('FaceNet Extractor')
      parser.add_argument('--facenet_dir', type=str, default='./weights', 
                          help='the directory of facenet model')
      parser.add_argument('--facenet_name', type=str, default='facenet-vggface2.pt',
                          help='the name of facenet model facenet-vggface2.pt / facenet-webface.pt')

      args =parser.parse_args()
      return args



##########################  人脸特征提取算法  ##########################
class DlibExtractor(object):
      """use dlib to extract face features and descriptors
      :param input: the camera RGB frame
      :param args: generated by config function """
      def __init__(self, input_path, args, **kwargs):
            self.args = args
            predictor_path = os.path.join(self.args.dlib_dirs, self.args.dlib_predictor)
            resnet_path = os.path.join(self.args.dlib_dirs, self.args.dlib_resnet)
            # Initialize model functions
            self.predictor = dlib.shape_predictor(predictor_path)
            self.face_rec = dlib.face_recognition_model_v1(resnet_path)
            self.detector = dlib.get_frontal_face_detector()
            # process input frame, usually is gray image
            self.input = np.array(Image.fromarray(input_path).convert('RGB'))
      def __extract__(self):
            """extract face descriptors for recognition"""
            faces = self.detector(self.input)
            try: shape = self.predictor(self.input, faces[0])
            except: RuntimeError('No Face has been detected!')
            face_descriptor = self.face_rec.compute_face_descriptor(self.input, shape)
            return face_descriptor


class FaceNetExtractor(object):
      """use facenet to extract face features and descriptors
      :param input: the camera RGB frame
      :param args: generated by config function """
      def __init__(self, input_path, args, **kwargs):
            self.args = args
            self.input = np.array(Image.open(input_path).convert('RGB'))
            self.weight_path = os.path.join(args.face_dir, args.face_name)
            if not os.path.exists(self.weight_path): self.__download__()

      def __download__(self):
            """download facenet model
            :returen :the loaded weights model"""
            model = tf.saved_model.load(self.weight_path)
            infer_model = model.signatures['serving_default']
            return infer_model
      def __extract__(self):
            """extract face descriptors for recognition"""
            pass



##########################  主函数测试分析  ##########################
if __name__=='__main__':
      """Testing the facial recognition model"""
      args = face_config()
      input = cv2.imread(r'assets\face0.jpg')

      # 1. Dlib Extractor
      dlib_extractor = DlibExtractor(input, args)
      print(dlib_extractor.__extract__())
